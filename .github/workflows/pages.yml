name: Deploy ArtSpace to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure GitHub Pages site exists
        id: ensure-pages
        shell: bash
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pages"

          # check whether Pages site already exists
          status_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "$API_URL" )

          if [ "$status_code" = "200" ]; then
            echo "Pages site already configured."; exit 0
          fi

          if [ "$status_code" = "404" ]; then
            echo "Pages site not found for repository ${GITHUB_REPOSITORY}."

            if [ -n "${PAGES_ADMIN_TOKEN:-}" ]; then
              echo "Attempting to create Pages site using provided PAGES_ADMIN_TOKEN..."
              resp_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${PAGES_ADMIN_TOKEN}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "$API_URL" -d '{"source":{"branch":"main","path":"/"}}')

              if [ "$resp_code" = "201" ] || [ "$resp_code" = "204" ]; then
                echo "Pages site created successfully."; exit 0
              else
                echo "Failed to create Pages site (HTTP $resp_code). Ensure the token has 'Administration' + 'Pages' repo permissions."; exit 1
              fi
            fi

            echo "GitHub Pages is not enabled for this repository.\n- Option A: Enable Pages at https://github.com/${GITHUB_REPOSITORY}/settings/pages (recommended).\n- Option B: Add a repo secret named 'PAGES_ADMIN_TOKEN' containing a PAT with 'Administration' and 'Pages' permissions so the workflow can create the site automatically.";
            exit 1
          fi

          echo "Unexpected response from Pages API: HTTP $status_code"; exit 1
        env:
          PAGES_ADMIN_TOKEN: ${{ secrets.PAGES_ADMIN_TOKEN }}

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
